<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Register</title>

  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; background:#f3f4f6; }
    .card { background:#fff; padding:28px; width:380px; border-radius:14px; box-shadow:0 10px 30px rgba(2,6,23,0.08); margin:80px auto; }
    .field { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; }
    .row { display:flex; gap:8px; }
    button { border-radius:10px; padding:10px 12px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px; }
    button:disabled { background:#9ca3af !important; cursor:not-allowed; }
    .small { font-size:12px; color:#6b7280; }
    .error { color:#ef4444; font-size:13px; margin-top:6px; }
    #passwordProgress { height:6px; border-radius:6px; background:#e5e7eb; overflow:hidden; margin-top:6px; }
    #passwordProgressFill { width:0%; height:100%; transition:width .25s, background .25s; }
    .toggle { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:14px; color:#6b7280; }
    .input-group { position:relative; }
  </style>
</head>
<body>

  <div class="card">
    <h2 class="text-xl font-bold text-center mb-4">Create Account</h2>

    <form id="registerForm" novalidate>
      <div class="mb-3">
        <input id="email" class="field" type="email" placeholder="Email" required />
      </div>

      <div class="mb-3 input-group">
        <input id="password" class="field" type="password" placeholder="Password (min 8 characters)" minlength="8" required />
        <span class="toggle" onclick="togglePassword('password', this)">👁️</span>
        <div id="passwordProgress"><div id="passwordProgressFill"></div></div>
        <p id="passwordStrength" class="small mt-1"></p>
      </div>

      <div class="mb-3 input-group">
        <input id="confirmPassword" class="field" type="password" placeholder="Confirm Password" required />
        <span class="toggle" onclick="togglePassword('confirmPassword', this)">👁️</span>
        <p id="passwordError" class="error hidden">Passwords do not match.</p>
      </div>

      <div class="mb-3 row">
        <select id="countryCode" class="field" style="width:120px; font-size:14px;">
          <option value="+62">🇮🇩 +62</option>
          <option value="+60">🇲🇾 +60</option>
          <option value="+91">🇮🇳 +91</option>
          <option value="+880">🇧🇩 +880</option>
        </select>
        <input id="phone" class="field" type="text" placeholder="Phone Number (optional)" />
      </div>

      <div class="mb-3">
        <button id="registerBtn" type="submit" class="w-full bg-blue-600 text-white" disabled>
          <span id="btnText">Register</span>
          <span id="btnSpinner" class="hidden animate-spin">⏳</span>
        </button>
      </div>
    </form>

    <p class="small text-center">Already have an account? <a href="login.html" style="color:#2563eb">Login</a></p>
  </div>

<script>
function togglePassword(id, el) {
  const input = document.getElementById(id);
  if (input.type === "password") {
    input.type = "text";
    el.textContent = "🙈";
  } else {
    input.type = "password";
    el.textContent = "👁️";
  }
}

document.addEventListener("DOMContentLoaded", function() {
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCP88iQpWKrudwkZpbWPQAERome4W8RnvQ",
    authDomain: "web-app-e586a.firebaseapp.com",
    projectId: "web-app-e586a",
    storageBucket: "web-app-e586a.appspot.com",
    messagingSenderId: "979871478072",
    appId: "1:979871478072:web:010a1f0b44bc4d977011cd",
    measurementId: "G-C2TH8LGXFZ"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // DOM
  const emailEl = document.getElementById("email");
  const pwdEl = document.getElementById("password");
  const confirmEl = document.getElementById("confirmPassword");
  const registerBtn = document.getElementById("registerBtn");
  const passwordError = document.getElementById("passwordError");
  const passwordStrength = document.getElementById("passwordStrength");
  const passwordProgressFill = document.getElementById("passwordProgressFill");
  const btnText = document.getElementById("btnText");
  const btnSpinner = document.getElementById("btnSpinner");

  // validation
  function isEmailValid() { return emailEl.checkValidity(); }
  function isPasswordValid() { return pwdEl.value.length >= 8; }
  function passwordsMatch() { return pwdEl.value === confirmEl.value && confirmEl.value.length > 0; }

  function updateRegisterButton() {
    registerBtn.disabled = !(isEmailValid() && isPasswordValid() && passwordsMatch());
  }
  function updatePasswordMatchUI() {
    if (!confirmEl.value) {
      passwordError.classList.add("hidden");
    } else if (pwdEl.value !== confirmEl.value) {
      passwordError.classList.remove("hidden");
    } else {
      passwordError.classList.add("hidden");
    }
  }
  function evaluateStrength(pw) {
    let s=0;
    if (pw.length >= 8) s++;
    if (/[A-Z]/.test(pw)) s++;
    if (/[0-9]/.test(pw)) s++;
    if (/[^A-Za-z0-9]/.test(pw)) s++;
    return s;
  }
  function updatePasswordUI() {
    const pw = pwdEl.value;
    const s = evaluateStrength(pw);
    if (!pw) {
      passwordStrength.textContent = "";
      passwordProgressFill.style.width = "0%";
      passwordProgressFill.style.background = "#9ca3af";
    } else if (s <= 1) {
      passwordStrength.textContent = "Weak password";
      passwordStrength.style.color = "#ef4444";
      passwordProgressFill.style.width = "25%";
      passwordProgressFill.style.background = "#ef4444";
    } else if (s === 2) {
      passwordStrength.textContent = "Medium password";
      passwordStrength.style.color = "#f59e0b";
      passwordProgressFill.style.width = "50%";
      passwordProgressFill.style.background = "#f59e0b";
    } else if (s === 3) {
      passwordStrength.textContent = "Good password";
      passwordStrength.style.color = "#3b82f6";
      passwordProgressFill.style.width = "75%";
      passwordProgressFill.style.background = "#3b82f6";
    } else {
      passwordStrength.textContent = "Strong password";
      passwordStrength.style.color = "#10b981";
      passwordProgressFill.style.width = "100%";
      passwordProgressFill.style.background = "#10b981";
    }
  }

  // event
  emailEl.addEventListener("input", updateRegisterButton);
  pwdEl.addEventListener("input", () => { updatePasswordUI(); updatePasswordMatchUI(); updateRegisterButton(); });
  confirmEl.addEventListener("input", () => { updatePasswordMatchUI(); updateRegisterButton(); });

  // submit
  const form = document.getElementById("registerForm");
  form.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    if (!isEmailValid() || !isPasswordValid() || !passwordsMatch()) return;

    registerBtn.disabled = true;
    btnText.textContent = "Registering...";
    btnSpinner.classList.remove("hidden");

    const email = emailEl.value.trim();
    const password = pwdEl.value;
    const countryCode = document.getElementById("countryCode").value;
    const phone = (document.getElementById("phone").value || "").trim();
    const fullPhone = phone ? (countryCode + phone) : "";

    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const user = userCredential.user;

      // simpan user ke firestore
      await db.collection("users").doc(user.uid).set({ email, phone: fullPhone });

      // kirim email verifikasi (background, tidak menunggu)
      user.sendEmailVerification();

      Swal.fire({
        icon: 'success',
        title: 'Registrasi Berhasil',
        text: 'Silahkan login dengan akun anda',
        timer: 2000,
        showConfirmButton: false
      }).then(() => {
        window.location.href = "login.html";
      });

    } catch (err) {
      Swal.fire({
        icon: 'error',
        title: 'Gagal Registrasi',
        text: err.message || "Terjadi error saat registrasi"
      });
      registerBtn.disabled = false;
      btnText.textContent = "Register";
      btnSpinner.classList.add("hidden");
    }
  });

  updatePasswordUI();
  updatePasswordMatchUI();
  updateRegisterButton();
});
</script>

</body>
</html>
